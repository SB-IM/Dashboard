<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>superdock - sb.im</title>
  <link rel="stylesheet" href="./bower_components/layui/dist/css/layui.css">
</head>
<body class="layui-layout-body">
<div class="layui-layout layui-layout-admin">
  <div class="layui-header">
    <div class="layui-logo">superdock - sb.im</div>
    <!-- 头部区域（可配合layui已有的水平导航） -->
    <ul class="layui-nav layui-layout-left">
      <li class="layui-nav-item"><a href="">飞行器</a></li>
      <li class="layui-nav-item layui-this"><a href="">机场</a></li>
    </ul>
    <ul class="layui-nav layui-layout-right">
      <li class="layui-nav-item">
        <a href="javascript:;">
          <img src="http://t.cn/RCzsdCq" class="layui-nav-img">
          贤心
        </a>
        <dl class="layui-nav-child">
          <dd><a href="">基本资料</a></dd>
          <dd><a href="">安全设置</a></dd>
        </dl>
      </li>
      <li class="layui-nav-item"><a href="">退了</a></li>
    </ul>
  </div>

  <div class="layui-side layui-bg-black">
    <div class="layui-side-scroll">
      <!-- 左侧导航区域（可配合layui已有的垂直导航） -->
      <ul class="layui-nav layui-nav-tree"  lay-filter="test">
        <li class="layui-nav-item layui-nav-itemed">
          <a class="" href="javascript:;">控制</a>
          <dl class="layui-nav-child">
            <dd><a href="javascript:;">Websocket</a></dd>
          </dl>
        </li>
        <li class="layui-nav-item"><a href="">A&Q</a></li>
        <li class="layui-nav-item"><a href="">联系我们</a></li>
      </ul>
    </div>
  </div>

  <div class="layui-body">
    <!-- 内容主体区域 -->
    <div style="padding: 15px;">
      <fieldset class="layui-elem-field">
        <legend>机舱内实时状态</legend>
        <div class="layui-field-box">
          <img src="http://192.168.100.121:8080/?action=stream" />
        </div>
      </fieldset>
      <hr class="layui-bg-blue">
      <div id="app">
        <button v-on:click="sendMessage('start')" class="layui-btn">start</button>
        <button v-on:click="sendMessage('stop')" class="layui-btn">stop</button>
      </div>

      <h3>Web Console</h3>
      <div class="layui-row">
        <div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
          <div id="console">
            <div>
              <div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
                <input v-model="hostname" class="layui-input"/>
              </div>
              <div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
                <input v-model="port" class="layui-input"/>
              </div>
              <div v-if="connect_status == 0" >
                <button v-on:click="connect()" class="layui-btn">连接</button>
              </div>
              <div v-else>
                <button v-on:click="close()" class="layui-btn">断开</button>
              </div>
            </div>
            <div>
              <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
                <input v-model="message" class="layui-input"/>
              </div>
              <button v-on:click="send()" class="layui-btn">发送</button>
            </div>
            <hr class="layui-bg-green">
            <li v-for="cmd in commands" class="layui-inline">
              <button v-bind:onclick="['console.send(\'' + cmd.value + '\')']" class="layui-btn">{{ cmd.name }}</button>&nbsp&nbsp&nbsp&nbsp
            </li>
              <button v-on:click="clean()" class="layui-btn">清空内容</button>
            <div>
              <div>来自服务端的消息</div>
              <textarea cols="100" rows="10" readonly="readonly">{{ content }}</textarea>
            </div>
          </div>
        </div>

      </div>
  </div>

  <div class="layui-footer">
    <!-- footer fix zone -->
    © sb.im - 2017
  </div>
</div>
<script src="./bower_components/layui/dist/layui.js"></script>
<script>
//Layui JavaScript
layui.use('element', function(){
  var element = layui.element;

});
</script>

<script src="./bower_components/vue/dist/vue.js"></script>
<script src="./bower_components/axios/dist/axios.js"></script>
<script>

window.onbeforeunload = function () {
    console.close()
}

var console = new Vue({
  el: '#console',
  data: {
    commands: [
      { name: '打开舱门～ | ω・´) ～', value: 'door_up' },
      { name: '关闭舱门～ (＾o＾)ﾉ ～', value: 'door_down' },
      { name: '平台上升～唔喵～', value: 'plet_up' },
      { name: '平台下降～酱紫～', value: 'plet_down' },
      { name: '固定开始～唔喵～', value: 'fix_up' },
      { name: '固定解除～酱紫～', value: 'fix_down' },
      { name: '电池锁定～ (*ﾟーﾟ) ～', value: 'lock_up' },
      { name: '电池开锁～ (・∀・) ～', value: 'lock_down' },
      { name: '电池前进～唔喵～', value: 'push_up' },
      { name: '电池后退～酱紫～', value: 'push_down' },
      { name: '电池上升～唔喵～', value: 'b_up' },
      { name: '电池下降～酱紫～', value: 'b_down' },
      { name: '顺时旋转～唔喵～', value: 'roate_up' },
      { name: '逆时旋转～酱紫～', value: 'roate_down' },
      { name: '全部停止～ Σ( ﾟдﾟ) ～', value: 'stop_all' },
      { name: '测试', value: 'test' }
    ],
    hostname: window.location.hostname,
    port: '22333',
    message: 'hello',
    connect_status: false,
    content: ''
  },
	methods: {
    connect: function () {
      //alert(this.hostname + ':' + this.port)
      var host = "ws://" + this.hostname + ":" + this.port + "/"
      socket = new WebSocket(host)
      try {

        socket.onopen = function (msg) {
          //$("btnConnect").disabled = true;
          //alert("连接成功！")
          console.connect_status = socket.readyState
        }

        socket.onmessage = function (msg) {
          if (typeof msg.data == "string") {
            log(msg.data)
          }
          else {
            alert("非文本消息");
          }
        }

        socket.onclose = function (msg) {
          //alert("socket closed!")
          console.connect_status = false
        }
      }
      catch (ex) {
        //log(ex)
        alert(ex)
      }
    },
    send: function (msg = this.message) {
      //alert(msg)
      socket.send(msg)
    },
    close: function () {
      try {
        socket.close()
        socket = null
      }
      catch (ex) {
        alert(ex)
      }
    },
    clean: function () {
      this.content = ""
    }
  }
})

Date.prototype.Format = function (fmt) { //author: meizz
  var o = {
    "M+": this.getMonth() + 1, //月份
    "d+": this.getDate(), //日
    "h+": this.getHours(), //小时
    "m+": this.getMinutes(), //分
    "s+": this.getSeconds(), //秒
    "q+": Math.floor((this.getMonth() + 3) / 3), //季度
    "S": this.getMilliseconds() //毫秒
  };
  if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
  for (var k in o)
    if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
  return fmt;
}

var msg_tmp = ''
function log(msg) {
    //console.content += new Date().Format("yyyy/MM/dd hh:mm:ss")+ ":  " + msg
  msg_tmp += msg
  //alert(msg_tmp)
  if (msg_tmp.indexOf("\n") != -1) {
    console.content += new Date().Format("yyyy/MM/dd hh:mm:ss")+ ":  " + msg_tmp
    msg_tmp = ''
  }
}


var app = new Vue({
  el: '#app',
  data: {
    items: false
  },
	methods: {
    sendMessage: function (cmd) {
    //axios.get('/action/start')
    axios.get('http://localhost:3000/depot/'+ cmd)
    axios.get('/action.php?cmd='+ cmd)
    }
	}
})
</script>

<!-- Weather plugins of seniverse.com -->
<script>(function(T,h,i,n,k,P,a,g,e){g=function(){P=h.createElement(i);a=h.getElementsByTagName(i)[0];P.src=k;P.charset="utf-8";P.async=1;a.parentNode.insertBefore(P,a)};T["ThinkPageWeatherWidgetObject"]=n;T[n]||(T[n]=function(){(T[n].q=T[n].q||[]).push(arguments)});T[n].l=+new Date();if(T.attachEvent){T.attachEvent("onload",g)}else{T.addEventListener("load",g,false)}}(window,document,"script","tpwidget","//widget.seniverse.com/widget/chameleon.js"))</script>
<script>tpwidget("init", {
    "flavor": "bubble",
    "location": "WX4FBXXFKE4F",
    "geolocation": "enabled",
    "position": "bottom-right",
    "margin": "10px 10px",
    "language": "auto",
    "unit": "c",
    "theme": "chameleon",
    "uid": "U6330AC00A",
    "hash": "75d296be2d9d0d336fa5ee10ed3bc879"
});
tpwidget("show");</script>
</body>
</html>
